<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type"
              content="text/html; charset=utf-8"/>
        <meta name="viewport"
              content="width=device-width, initial-scale=1.0" />
        <script
            src='https://code.responsivevoice.org/responsivevoice.js'>
        </script>
        <link rel="stylesheet"
              href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
        <script
            src="http://code.jquery.com/jquery-1.11.3.min.js">
        </script>
        <script
            src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js">
        </script>
        <script src='/socket.io/socket.io.js'></script>
        <script>

         window.dayOffset = 0;
         window.examples = {};
         window.ttsStop = false;

         var fnPlay = function(e){
             window.ttsStop = false;

             var fnSpeak = function(example){
                 var speaker = "US English Male";
                 var onNext = function(){
                     setTimeout(fnSpeak.bind(this, example), 3000);
                 };
                 if (window.ttsStop){
                     window.ttsStop = false;
                     return;
                 }
                 responsiveVoice.speak(example, speaker, {onend:onNext});
             };

             fnSpeak(e);
         };

         var socket = io.connect('http://' + location.host);

         var fnDeleteExample = function(dayOffset, index){
             socket.emit('delete_example'
                       , {day_offset:dayOffset, index:index});
         }

         var fnPlayNextSentence = function(e, currIdx){
             if (!(currIdx in e)){
                 if (currIdx == 0){
                    console.log("Empty examples?");
                    return;
                 }

                 currIdx = 0;
             }

             var sentence = e[currIdx].example;
             var word = e[currIdx].word;
             var speaker = "US English Male";
             var fnNextPlay = fnPlayNextSentence.bind(this,
                                                      e, currIdx+1);
             responsiveVoice.speak(sentence, speaker,
                                   {onend:fnNextPlay});
             $('#id_play_all').prop('value', 'Playing ' + word);
         };

         $(document).ready(function(){

             socket.emit('req_example', {day_offset:0, delta:0});

             socket.on('res_example', function(jsonData){
                 window.ttsStop = false;
                 window.dayOffset = jsonData.day_offset;
                 window.examples = jsonData.data;

                 var d = new Date(jsonData.date);
                 var dayStr = d.toLocaleString(
                     window.navigator.language,
                     {weekday: 'long'});
                 var dateStr = jsonData.date + ' (' + dayStr + ')';
                 $('#id_date').text(dateStr);
                 $('#id_examples').empty();

                 var len = examples.length;
                 for (var i=0; i<len; i++)
                 {
                     var example = examples[i].example;
                     var word = examples[i].word;
                     var sentence = example.replace(
                         word,
                         $('<strong/>').text(word).prop('outerHTML'));

                     var sentenceTag = $('<a href="#" style="white-space: normal;"/>').append(
                         sentence);


                     sentenceTag.click(fnPlay.bind(this, example));

                     var deleteTag = $('<a href="#" data-icon="delete"/>');
                     deleteTag.click(
                         fnDeleteExample.bind(this, dayOffset, i));

                     $('#id_examples').append(
                         $('<li/>')
                         .append(sentenceTag)
                         .append(deleteTag)
                     );
                 }

                 $('#id_examples').listview('refresh');
             });

             $('#id_play_all').click(function(){
                 fnPlayNextSentence(examples, 0);
             });

             $('#id_play_stop').click(function(){
                 window.ttsStop = true;
                 responsiveVoice.cancel();
                 $('#id_play_all').prop('value', 'Play ALL');
             });

             $('#id_btn_day_prev').click(function(){
                 $(this).removeClass('ui-btn-active')
                 socket.emit('req_example',
                     {day_offset:window.dayOffset, delta:-1});
             });

             $('#id_btn_day_next').click(function(){
                 $(this).removeClass('ui-btn-active')
                 socket.emit('req_example',
                     {day_offset:window.dayOffset, delta:1});
             });

             $('#id_btn_send_new_example').click(function(){
                 var inputElem = $('#id_new_example');
                 var example = inputElem.val();
                 if (example.length == 0)
                     return;
                 socket.emit('add_example', {example:example});
                 inputElem.val('');
             });
         });

        </script>
        <title>english examples</title>
    </head>

    <body>
        <div data-role="page" id="id_page">
            <div data-role="header">
                <h1 id="id_date"> date </h1>
                <div data-role="navbar" >
                    <ul>
                        <li>
                            <a href="#" id="id_btn_day_prev"
                               data-icon="arrow-l" ></a>
                        </li>
                        <li>
                            <a href="#" id="id_btn_day_next"
                               data-icon="arrow-r" ></a>
                        </li>
                    </ul>
                </div>
            </div>

            <ul id="id_examples" data-role="listview" data-theme="g">
            </ul>

            <p>
                <input id='id_play_all' type='button' value='Play ALL'/>
                <input id='id_play_stop' type='button' value='stop current play'/>
            </p>

            <p>
                <input id='id_new_example' type='text' size="30"/>
                <input id='id_btn_send_new_example' type='button' value="send"/>
            </p>
        </div>
    </body>

</html>
